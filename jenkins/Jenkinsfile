pipeline {
 agent any
 tools {
  terraform 'TerraformDefault'  
 }
 // Define environment variables for AWS credentials
 environment {
  TF_VAR_aws_access_key = credentials('AWSAccessKey')
  TF_VAR_aws_secret_key = credentials('AWSSecretKey')
  BUCKET_NAME = ''
 }
 stages {
  stage('Terraform Init') {
    steps {
      // Change to the 'terraform' directory and run 'terraform init'
      dir('terraform') {
       sh 'terraform init'
      }
    }
  }
  stage('Terraform Plan') {
   steps {
    // Run 'terraform plan' within the 'terraform' directory
    dir('terraform') {
     sh 'terraform plan -var-file=variables.tfvars'
    }
   }
  }
  stage('Terraform Apply') {
   steps {
    // Apply the Terraform changes within the 'terraform' directory
    dir('terraform') {
     sh 'terraform apply -auto-approve -var-file=variables.tfvars'
     script {
      def terraformOutput = sh(script: '''terraform output bucket_name | awk -F= '{print $2}' | tr -d ' "' ''', returnStdout: true).trim()
      echo "Obtained BUCKET_NAME: ${terraformOutput}"
      env.BUCKET_NAME = terraformOutput
     }
    }
   }
  }
  stage('Download Elastic APM Agent') {
   steps {
    sh "curl -o 'elastic-apm-agent.jar' -L 'https://oss.sonatype.org/service/local/artifact/maven/redirect?r=releases&g=co.elastic.apm&a=elastic-apm-agent&v=LATEST'"
   }
  }
  stage('Upload agent to S3 bucket') {
   steps {
    withAWS(credentials: 'AWSKey') {
     sh "aws s3 cp elastic-apm-agent.jar s3://${BUCKET_NAME}/"
    }
   }
  }
 }
}




